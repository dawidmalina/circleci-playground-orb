description: >
  Install and connect to Tailscale network

parameters:
  tailscale_auth_key:
    type: env_var_name
    description: Your Tailscale authentication key, from the admin panel.
    default: TAILSCALE_AUTH_KEY
  tailscale_proxy_address:
    type: string
    description: Proxy address where tailscale should listen.
    default: 127.0.0.1:1055
  tailscale_advertise_tags:
    type: string
    description: Tags that tailscale should advertised
    default: tag:ci

steps:
  - run:
      name: Download and Install Tailscale
      command: |
        curl -fsSL https://tailscale.com/install.sh | sh

  - run:
      name: Start Tailscale
      command: |
          tailscaled \
            --tun=userspace-networking \
            --socket=/tmp/tailscaled.sock \
            --socks5-server=<< parameters.tailscale_proxy_address >>
      background: true

  - run:
      name: Tailscale Up
      command: |
          HOSTNAME="circleci-$(cat /etc/hostname)"
          tailscale up \
            --socket=/tmp/tailscaled.sock \
            --authkey ${<< parameters.tailscale_auth_key >>} \
            --advertise-tags=<< parameters.tailscale_advertise_tags >> \
            --hostname=${HOSTNAME} \
            --accept-routes \
            --timeout=10s
